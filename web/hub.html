<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Careers Hub · Careers10 Arena</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="page">
    <section class="card">
      <h2 style="margin:0">Careers Hub</h2>
      <p class="muted small" style="margin-top:8px;">
        Brainstorm/help understand concepts only. Do <strong>not</strong> post finished assignment answers.
        Categories: Resume, References, Interview, Assignment Help (brainstorm), Resources.
      </p>
      <div id="hubStatus" class="status">Loading...</div>
    </section>

    <div class="grid cols-2" style="margin-top:12px;">
      <section class="card">
        <h3>Create Post</h3>
        <form id="hubForm" class="col">
          <label>Category
            <select id="hubCategory">
              <option>Resume</option>
              <option>References</option>
              <option>Interview</option>
              <option>Assignment Help</option>
              <option>Resources</option>
            </select>
          </label>
          <label>Title <input id="hubTitle" maxlength="120" required></label>
          <label>Tags (optional) <input id="hubTags" maxlength="120" placeholder="resume, interview, job fair"></label>
          <label>Body <textarea id="hubBody" maxlength="4000" required placeholder="Ask for ideas, explain what you’re stuck on, share resources, etc."></textarea></label>
          <div class="row">
            <button class="ok" type="submit">Post</button>
            <span id="hubComposeHint" class="muted small">Keep it class-appropriate.</span>
          </div>
        </form>
      </section>

      <section class="card">
        <h3>Feed Filters</h3>
        <div class="row">
          <label class="stretch">Search title/body <input id="hubSearch" placeholder="Find posts..."></label>
        </div>
        <div class="row">
          <label class="stretch">Category
            <select id="hubFilterCategory">
              <option value="">All categories</option>
              <option>Resume</option>
              <option>References</option>
              <option>Interview</option>
              <option>Assignment Help</option>
              <option>Resources</option>
            </select>
          </label>
          <button id="hubRefreshBtn" type="button">Refresh</button>
        </div>
        <div class="status small" id="hubLiveStatus">Live updates connect after page load.</div>
      </section>
    </div>

    <section class="card" style="margin-top:12px;">
      <div class="row space">
        <h3 style="margin:0">Posts</h3>
        <span id="hubCount" class="pill">0 posts</span>
      </div>
      <div id="hubFeed" class="list" style="margin-top:10px;"></div>
    </section>
  </div>

  <script type="module">
    import { api, getSharedWS } from "/js/net.js";
    import { $, $$, escapeHtml, installTopbar, requireAuth, setStatus, toast, tsToLocal } from "/js/ui.js";

    let me = null;
    let ws = null;
    let posts = [];

    function postMatches(post) {
      const q = $("#hubSearch").value.trim().toLowerCase();
      const cat = $("#hubFilterCategory").value;
      if (cat && post.category !== cat) return false;
      if (!q) return true;
      return (post.title || "").toLowerCase().includes(q) || (post.body || "").toLowerCase().includes(q) || (post.tags || "").toLowerCase().includes(q);
    }

    function renderFeed() {
      const feed = $("#hubFeed");
      const filtered = posts.filter(postMatches);
      $("#hubCount").textContent = `${filtered.length} post${filtered.length === 1 ? "" : "s"}`;
      if (!filtered.length) {
        feed.innerHTML = `<div class="list-item muted">No posts yet.</div>`;
        return;
      }
      feed.innerHTML = filtered.map((p) => {
        const adminBtns = me?.is_admin ? `
          <div class="row tiny" style="margin-top:8px;">
            <button type="button" class="ghost" data-delete-post="${p.id}">Delete Post</button>
            <button type="button" class="ghost" data-mute-user="${p.user_id}">Mute 10m</button>
          </div>` : "";
        return `
          <article class="list-item post-card">
            <div class="row space">
              <div class="pill">${escapeHtml(p.category)}</div>
              <div class="meta">${tsToLocal(p.created_at)} · #${p.id}</div>
            </div>
            <div class="title">${escapeHtml(p.title)}</div>
            <div class="meta">${escapeHtml(p.display_name || p.username)} · @${escapeHtml(p.username)}${p.tags ? ` · tags: ${escapeHtml(p.tags)}` : ""}</div>
            <div class="body" style="margin-top:6px;">${escapeHtml(p.body)}</div>
            ${adminBtns}
          </article>
        `;
      }).join("");

      $$("[data-delete-post]").forEach((btn) => btn.addEventListener("click", () => ws.send({ type: "hub_delete", post_id: Number(btn.dataset.deletePost) })));
      $$("[data-mute-user]").forEach((btn) => btn.addEventListener("click", () => ws.send({ type: "admin_mute", user_id: Number(btn.dataset.muteUser), minutes: 10 })));
    }

    async function refreshFeed() {
      try {
        const res = await api("/api/hub_feed");
        posts = res.posts || [];
        renderFeed();
        setStatus($("#hubStatus"), "Hub feed loaded.", "ok");
      } catch (e) {
        setStatus($("#hubStatus"), `Failed to load feed: ${e.message}`, "err");
      }
    }

    async function init() {
      me = await requireAuth();
      installTopbar({ pageTitle: "Careers Hub" });
      setStatus($("#hubStatus"), `Signed in as ${me.display_name}${me.is_admin ? " (admin)" : ""}.`, "ok");
      await refreshFeed();

      $("#hubSearch").addEventListener("input", renderFeed);
      $("#hubFilterCategory").addEventListener("change", renderFeed);
      $("#hubRefreshBtn").addEventListener("click", refreshFeed);

      $("#hubForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const payload = {
            category: $("#hubCategory").value,
            title: $("#hubTitle").value,
            body: $("#hubBody").value,
            tags: $("#hubTags").value,
          };
          const res = await api("/api/hub_post", { method: "POST", json: payload });
          toast("Post created", "ok");
          $("#hubTitle").value = "";
          $("#hubBody").value = "";
          $("#hubTags").value = "";
          posts.unshift(res.post);
          renderFeed();
        } catch (e2) {
          toast(`Post failed: ${e2.payload?.error || e2.message}`, "err");
        }
      });

      ws = getSharedWS();
      await ws.connect();
      ws.on("hello_ok", () => setStatus($("#hubLiveStatus"), "Live updates connected.", "ok"));
      ws.on("hub_new_post", (m) => {
        posts = [m.post, ...posts.filter((p) => p.id !== m.post.id)];
        renderFeed();
      });
      ws.on("hub_deleted", (m) => {
        if (!m.ok) return;
        posts = posts.filter((p) => Number(p.id) !== Number(m.post_id));
        renderFeed();
      });
      ws.on("announcement", (m) => {
        toast(`Announcement: ${m.text}`);
      });
      ws.on("error", (m) => {
        if (m.error) setStatus($("#hubLiveStatus"), `WS error: ${m.error}`, "err");
      });
    }

    init().catch((e) => {
      console.error(e);
      setStatus(document.getElementById("hubStatus"), `Hub failed to load: ${e.message}`, "err");
    });
  </script>
</body>
</html>

