<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lobby · Careers10 Arena</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="page">
    <section class="card">
      <div class="row space">
        <div>
          <h2 style="margin:0">LAN Lobby</h2>
          <div class="muted small">Create/join Arena or Mini-Game rooms. Share room links on the local network.</div>
        </div>
        <div class="row">
          <div class="pill" id="mePill">Loading user...</div>
          <div id="myCortisolBadge" class="pill">Cortisol: ...</div>
        </div>
      </div>
      <div id="lobbyStatus" class="status" style="margin-top:10px;">Connecting...</div>
    </section>

    <div class="grid cols-2" style="margin-top:12px;">
      <section class="card">
        <h3>Create / Join Arena Room</h3>
        <div class="row">
          <label class="stretch">Room ID <input id="arenaRoomId" value="arena-room"></label>
          <label>Mode
            <select id="arenaMode">
              <option value="duel">Duel (1v1)</option>
              <option value="teams">Teams (2v2)</option>
              <option value="ffa" selected>Free-for-all (up to 6)</option>
              <option value="boss">Boss Fight vs AI Hannigan</option>
              <option value="practice">Practice</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>Match Seconds <input id="arenaSeconds" type="number" min="60" max="120" value="90" style="width:110px"></label>
          <button id="goArenaBtn" class="ok" type="button">Open Arena</button>
          <button id="copyArenaBtn" type="button">Copy Join URL</button>
        </div>
      </section>

      <section class="card">
        <h3>Create / Join Mini-Game Room</h3>
        <div class="row">
          <label class="stretch">Room ID <input id="miniRoomId" value="mini-room"></label>
          <label>Mini-Game
            <select id="miniKind">
              <option value="chess">Chess</option>
              <option value="pong">Pong</option>
              <option value="reaction">Reaction Duel</option>
              <option value="typing">Typing Duel</option>
            </select>
          </label>
        </div>
        <div class="row">
          <button id="goMiniBtn" class="ok" type="button">Open Mini-Game</button>
          <button id="copyMiniBtn" type="button">Copy Join URL</button>
        </div>
      </section>
    </div>

    <div class="grid cols-2" style="margin-top:12px;">
      <section class="card">
        <div class="row space">
          <h3 style="margin:0">Active Rooms</h3>
          <button id="refreshLobbyBtn" type="button">Refresh</button>
        </div>
        <div id="serverInfo" class="status small" style="margin-top:8px;">Server info loading...</div>
        <div id="roomsList" class="room-grid" style="margin-top:10px;"></div>
      </section>

      <section class="card">
        <h3>Online Users</h3>
        <div id="onlineUsers" class="list"></div>
      </section>
    </div>

    <section class="card" style="margin-top:12px;">
      <div class="row space">
        <h3 style="margin:0">Cortisol Leaderboard</h3>
        <span class="muted small">Lower = better (Zen at the top)</span>
      </div>
      <div class="table-wrap" style="margin-top:8px;">
        <table>
          <thead>
            <tr><th>#</th><th>Name</th><th>User</th><th>Cortisol</th><th>W</th><th>L</th><th>KOs</th><th>D</th><th>Streak</th></tr>
          </thead>
          <tbody id="leaderboardBody"><tr><td colspan="9">Loading...</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
    import { copyToClipboard, getSharedWS, joinUrlFor } from "/js/net.js";
    import { api } from "/js/net.js";
    import { cortisolBadge, escapeHtml, installTopbar, renderLeaderboardTable, requireAuth, setStatus, toast } from "/js/ui.js";

    let me;
    let ws;
    let lobbyState = { rooms: [], online: [] };

    function arenaJoinUrl() {
      return joinUrlFor("arena.html", {
        room: document.getElementById("arenaRoomId").value.trim() || "arena-room",
        mode: document.getElementById("arenaMode").value,
        seconds: document.getElementById("arenaSeconds").value
      });
    }

    function miniJoinUrl() {
      const kind = document.getElementById("miniKind").value;
      const room = document.getElementById("miniRoomId").value.trim() || "mini-room";
      if (kind === "chess") return joinUrlFor("chess.html", { room });
      return joinUrlFor("minigames.html", { kind, room });
    }

    function renderOnline() {
      const box = document.getElementById("onlineUsers");
      const rows = lobbyState.online || [];
      if (!rows.length) {
        box.innerHTML = `<div class="list-item muted">Nobody online yet.</div>`;
        return;
      }
      box.innerHTML = rows.map((u) => `
        <div class="list-item">
          <div class="row space">
            <strong>${escapeHtml(u.display_name || u.username)}</strong>
            ${cortisolBadge(u.stats?.cortisol ?? 1000)}
          </div>
          <div class="tiny muted">@${escapeHtml(u.username)}${u.is_admin ? " · ADMIN" : ""}</div>
        </div>
      `).join("");
    }

    function roomActionUrl(r) {
      if (r.kind === "arena") return joinUrlFor("arena.html", { room: r.room_id, mode: r.mode_name || "ffa" });
      if (r.kind === "chess") return joinUrlFor("chess.html", { room: r.room_id });
      return joinUrlFor("minigames.html", { kind: r.kind, room: r.room_id });
    }

    function renderRooms() {
      const box = document.getElementById("roomsList");
      const rooms = lobbyState.rooms || [];
      if (!rooms.length) {
        box.innerHTML = `<div class="list-item muted">No active rooms yet. Make one.</div>`;
        return;
      }
      box.innerHTML = rooms.map((r) => `
        <div class="room-card">
          <div class="row space">
            <span class="pill">${escapeHtml(r.kind)}${r.mode_name ? ` · ${escapeHtml(r.mode_name)}` : ""}</span>
            <span class="tiny muted">${escapeHtml(r.state || "unknown")}</span>
          </div>
          <h3>${escapeHtml(r.room_id)}</h3>
          <div class="small muted">Players: ${r.player_count} · Spectators: ${r.spectator_count}</div>
          ${r.time_left !== undefined ? `<div class="tiny muted">Time left: ${r.time_left}s</div>` : ""}
          <div class="row" style="margin-top:8px;">
            <a class="btn ok" href="${roomActionUrl(r)}">Join</a>
            <button type="button" class="btn ghost" data-copy-room="${r.room_key}">Copy Link</button>
          </div>
        </div>
      `).join("");
      box.querySelectorAll("[data-copy-room]").forEach((btn) => btn.addEventListener("click", () => {
        const roomKey = btn.dataset.copyRoom;
        const room = rooms.find((r) => r.room_key === roomKey);
        if (!room) return;
        copyToClipboard(roomActionUrl(room)).then(() => toast("Join URL copied", "ok"));
      }));
    }

    function renderServerInfo() {
      const server = lobbyState.server || {};
      const ips = (server.local_ips || []).join(", ");
      const boss = server.boss_enabled ? "ON" : "OFF";
      setStatus(document.getElementById("serverInfo"), `Boss Fight rooms: ${boss} · Local IPs: ${ips || "unknown"}`, server.boss_enabled ? "ok" : "warn");
    }

    function updateMyBadges() {
      document.getElementById("mePill").textContent = `${me.display_name} (@${me.username})${me.is_admin ? " · ADMIN" : ""}`;
      const c = me.stats?.cortisol ?? 1000;
      document.getElementById("myCortisolBadge").innerHTML = `Your cortisol rank: ${cortisolBadge(c)}`;
    }

    async function refreshLeaderboard() {
      try {
        const res = await api("/api/leaderboard?limit=100");
        renderLeaderboardTable(res.rows || [], document.getElementById("leaderboardBody"));
      } catch (e) {
        document.getElementById("leaderboardBody").innerHTML = `<tr><td colspan="9">Leaderboard error: ${e.message}</td></tr>`;
      }
    }

    async function init() {
      me = await requireAuth();
      installTopbar({ pageTitle: "Lobby" });
      updateMyBadges();
      setStatus(document.getElementById("lobbyStatus"), "Signed in. Connecting WebSocket...", "warn");
      await refreshLeaderboard();

      document.getElementById("goArenaBtn").addEventListener("click", () => location.href = arenaJoinUrl());
      document.getElementById("copyArenaBtn").addEventListener("click", () => copyToClipboard(arenaJoinUrl()).then(() => toast("Arena join URL copied", "ok")));
      document.getElementById("goMiniBtn").addEventListener("click", () => location.href = miniJoinUrl());
      document.getElementById("copyMiniBtn").addEventListener("click", () => copyToClipboard(miniJoinUrl()).then(() => toast("Mini-game join URL copied", "ok")));
      document.getElementById("refreshLobbyBtn").addEventListener("click", () => ws.send({ type: "get_lobby" }));

      ws = getSharedWS();
      await ws.connect();
      ws.on("hello_ok", (m) => {
        me = m.me;
        updateMyBadges();
        setStatus(document.getElementById("lobbyStatus"), "Connected. Live lobby updates enabled.", "ok");
        ws.send({ type: "get_lobby" });
      });
      ws.on("lobby_state", (m) => {
        lobbyState = m;
        renderRooms();
        renderOnline();
        renderServerInfo();
      });
      ws.on("presence", (m) => {
        lobbyState.online = m.online || [];
        renderOnline();
      });
      ws.on("announcement", (m) => {
        toast(`Announcement: ${m.text}`);
      });
      ws.on("server_flag", (m) => {
        if (typeof m.boss_enabled !== "undefined") {
          lobbyState.server = { ...(lobbyState.server || {}), boss_enabled: !!m.boss_enabled };
          renderServerInfo();
        }
      });
      ws.on("error", (m) => {
        setStatus(document.getElementById("lobbyStatus"), `WS error: ${m.error}`, "err");
      });

      if (ws.helloReady) ws.send({ type: "get_lobby" });
    }

    init().catch((e) => {
      console.error(e);
      setStatus(document.getElementById("lobbyStatus"), `Lobby failed to load: ${e.message}`, "err");
    });
  </script>
</body>
</html>

